@using OsayamiBlog.Services
@inject AnnotationRegistry Registry

<p>
@foreach (var segment in Segments)
{
    if (segment.Annotation is null)
    {
        @segment.Text
    }
    else
    {
        <AnnotatedSpan Annotation="segment.Annotation">
            @segment.Text
        </AnnotatedSpan>
    }
}
</p>

@code {
    [Parameter, EditorRequired]
    public Paragraph Paragraph { get; set; } = default!;

    private List<Segment> Segments = [];

    protected override void OnParametersSet()
    {
        Segments = BuildSegments();
    }

    private List<Segment> BuildSegments()
    {
        var segments = new List<Segment>();

        if (Paragraph.Annotations.Count == 0)
        {
            segments.Add(new Segment { Text = Paragraph.Text });
            return segments;
        }

        var index = 0;

        foreach (var ia in Paragraph.Annotations.OrderBy(a => a.Start))
        {
            var reg = Registry.Get(ia.AnnotationId);
            if (reg is null) continue;

            if (ia.Start > index)
            {
                segments.Add(new Segment
                {
                    Text = Paragraph.Text[index..ia.Start]
                });
            }

            segments.Add(new Segment
            {
                Text = Paragraph.Text.Substring(ia.Start, ia.Length),
                Annotation = reg.Annotation
            });

            index = ia.Start + ia.Length;
        }

        if (index < Paragraph.Text.Length)
        {
            segments.Add(new Segment
            {
                Text = Paragraph.Text[index..]
            });
        }

        return segments;
    }

    private sealed class Segment
    {
        public string Text { get; init; } = "";
        public Annotation? Annotation { get; init; }
    }
}
